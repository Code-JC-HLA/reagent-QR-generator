<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reagent QR Code Generator</title>
  <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 2rem; max-width: 600px; margin: auto; line-height: 1.5; }
    h1 { text-align: center; font-size: 1.8rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 1rem; font-weight: 600; font-size: 1rem; }
    input, button { width: 100%; padding: 0.6rem; margin-top: 0.4rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #0078d4; color: white; border: none; }
    button:hover:not(:disabled) { background-color: #005a9e; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #qr-container { text-align: center; margin-top: 2rem; }
    #qr-text { display: none; }
    .error { color: #d8000c; font-size: 0.9rem; margin-top: 0.2rem; }
  </style>
</head>
<body>
  <h1>Reagent QR Code Generator</h1>
  <form id="qr-form" novalidate>
    <label for="tasklist">Tasklist:</label>
    <input type="text" id="tasklist" placeholder="e.g., ABS-1059 or C1Q-584" required>
    <div class="error" id="error-tasklist"></div>
    <div id="reagents"></div>
    <button type="button" id="generateBtn">Generate QR Code</button>
    <button type="button" id="printBtn" disabled>Print QR</button>
  </form>
  <div id="qr-container">
    <canvas id="qr-canvas"></canvas>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof QRious !== 'function') {
        alert('QRious library failed to load.'); return;
      }
      function escapeHtml(str) {
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }
      const reagents = ["SAB Class I","SAB Class II","ExPlex Class I","ExPlex Class II","PBS","Anti-IgG PE","Negative Control Serum"];
      const container = document.getElementById('reagents');
      reagents.forEach(name => {
        const id = name.replace(/\s+/g, '_');
        const div = document.createElement('div');
        div.innerHTML =
          `<label for=\"lot-${id}\">${name} - Lot Number:</label>` +
          `<input type=\"text\" id=\"lot-${id}\" placeholder=\"e.g., 12345A\" required>` +
          `<div class=\"error\" id=\"error-lot-${id}\"></div>` +
          `<label for=\"exp-${id}\">${name} - Expiration Date:</label>` +
          `<input type=\"date\" id=\"exp-${id}\" required>` +
          `<div class=\"error\" id=\"error-exp-${id}\"></div>`;
        container.appendChild(div);
      });
      const qrCanvas = document.getElementById('qr-canvas');
      const qr = new QRious({ element: qrCanvas, size: 280, level: 'H', value: '' });
      const generateBtn = document.getElementById('generateBtn');
      const printBtn = document.getElementById('printBtn');
      function clearErrors() {
        document.getElementById('error-tasklist').textContent = '';
        reagents.forEach(name => {
          const id = name.replace(/\s+/g, '_');
          document.getElementById(`error-lot-${id}`).textContent = '';
          document.getElementById(`error-exp-${id}`).textContent = '';
        });
      }
      function validateInputs() {
        let valid = true; clearErrors();
        const tasklist = document.getElementById('tasklist').value.trim();
        if (!tasklist) { document.getElementById('error-tasklist').textContent = 'Required'; valid = false; }
        reagents.forEach(name => {
          const id = name.replace(/\s+/g, '_');
          if (!document.getElementById(`lot-${id}`).value.trim()) { document.getElementById(`error-lot-${id}`).textContent='Required'; valid=false; }
          if (!document.getElementById(`exp-${id}`).value)           { document.getElementById(`error-exp-${id}`).textContent='Required'; valid=false; }
        });
        return valid;
      }
      generateBtn.addEventListener('click', () => {
        if (!validateInputs()) return;
        const tasklist = document.getElementById('tasklist').value.trim();
        const timestamp = new Date().toLocaleString();
        const rows = [`Tasklist`, tasklist, `Generated`, timestamp];
        reagents.forEach(name => {
          const id = name.replace(/\s+/g, '_');
          rows.push(name, document.getElementById(`lot-${id}`).value.trim().toUpperCase(), document.getElementById(`exp-${id}`).value);
        });
        const text = rows.slice(0,2).join(': ') + '\n' + rows.slice(2).reduce((acc,cur,i)=> i%3===0? acc+`\n${cur}: `+rows[i+1]+' Exp: '+rows[i+2] : acc,'');
        qr.value = text;
        printBtn.disabled = false;
      });
      printBtn.addEventListener('click', () => {
        if (!qr.value) return;
        const popup = window.open('', '_blank'); if (!popup){alert('Allow popups.');return;}
        const imgData = qrCanvas.toDataURL();
        const rows = qr.value.split('\n');
        let tableRows = '';
        rows.forEach(line => {
          const parts = line.split('|').map(p=>p.trim());
          if (parts.length>1) {
            tableRows += `<tr><td>${escapeHtml(parts[0])}</td><td>${escapeHtml(parts.slice(1).join(' | '))}</td></tr>`;
          } else {
            const idx = tableRows?'':'<h2>'+escapeHtml(line)+'</h2>';
            tableRows = idx + tableRows;
          }
        });
        const html = `<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Print QR</title><style>
          body{font-family:'Segoe UI',sans-serif;margin:2rem;} h2{text-align:center;} table{width:100%;border-collapse:collapse;margin-top:1rem;} th,td{border:1px solid #333;padding:0.5rem;} th{background:#f4f4f4;text-align:left;}
        </style></head><body onload=\"window.print();window.close();\"><div style=\"text-align:center;\"><img src=\"${imgData}\" alt=\"QR Code\"></div>
        <table><thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>${tableRows}</tbody></table></body></html>`;
        popup.document.open(); popup.document.write(html); popup.document.close();
      });
    });
  </script>
</body>
</html>
