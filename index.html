<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reagent QR Code Generator</title>
  <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    input, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
    #qr-container { text-align: center; margin-top: 2rem; }
    #qr-text { white-space: pre-wrap; word-break: break-word; margin-top: 1rem; }
    .error { color: red; font-size: 0.9rem; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Reagent QR Code Generator</h1>
  <form id="qr-form" novalidate>
    <label for="tasklist">Tasklist:</label>
    <input type="text" id="tasklist" placeholder="e.g., ABS-1059 or C1Q-584" required>
    <div class="error" id="error-tasklist"></div>
    <div id="reagents"></div>
    <button type="button" id="generateBtn">Generate QR Code</button>
    <button type="button" id="printBtn" disabled>Print QR</button>
  </form>
  <div id="qr-container">
    <canvas id="qr-canvas"></canvas>
    <div id="qr-text"></div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof QRious !== 'function') {
        alert('QRious library failed to load. Please check your internet connection.');
        return;
      }
      function escapeHtml(str) {
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;');
      }
      const reagents = [
        "SAB Class I",
        "SAB Class II",
        "ExPlex Class I",
        "ExPlex Class II",
        "PBS",
        "Anti-IgG PE",
        "Negative Control Serum"
      ];
      const container = document.getElementById('reagents');
      reagents.forEach(name => {
        const id = name.replace(/\s+/g, '_');
        const div = document.createElement('div');
        div.innerHTML =
          `<label for=\"lot-${id}\">${name} - Lot Number:</label>` +
          `<input type=\"text\" id=\"lot-${id}\" placeholder=\"e.g., 12345A\" required>` +
          `<div class=\"error\" id=\"error-lot-${id}\"></div>` +
          `<label for=\"exp-${id}\">${name} - Expiration Date:</label>` +
          `<input type=\"date\" id=\"exp-${id}\" required>` +
          `<div class=\"error\" id=\"error-exp-${id}\"></div>`;
        container.appendChild(div);
      });
      const qrCanvas = document.getElementById('qr-canvas');
      const qr = new QRious({ element: qrCanvas, size: 300, level: 'H', value: '' });
      const generateBtn = document.getElementById('generateBtn');
      const printBtn = document.getElementById('printBtn');
      function clearErrors() {
        document.getElementById('error-tasklist').textContent = '';
        reagents.forEach(name => {
          const id = name.replace(/\s+/g, '_');
          document.getElementById(`error-lot-${id}`).textContent = '';
          document.getElementById(`error-exp-${id}`).textContent = '';
        });
      }
      function validateInputs() {
        let valid = true;
        clearErrors();
        const tasklist = document.getElementById('tasklist').value.trim();
        if (!tasklist) {
          document.getElementById('error-tasklist').textContent = 'Required';
          valid = false;
        }
        reagents.forEach(name => {
          const id = name.replace(/\s+/g, '_');
          const lot = document.getElementById(`lot-${id}`).value.trim();
          const exp = document.getElementById(`exp-${id}`).value;
          if (!lot) {
            document.getElementById(`error-lot-${id}`).textContent = 'Required';
            valid = false;
          }
          if (!exp) {
            document.getElementById(`error-exp-${id}`).textContent = 'Required';
            valid = false;
          }
        });
        return valid;
      }
      generateBtn.addEventListener('click', () => {
        if (!validateInputs()) return;
        const tasklist = document.getElementById('tasklist').value.trim();
        const timestamp = new Date().toLocaleString();
        const lines = [`Tasklist: ${tasklist}`, `Generated: ${timestamp}`].concat(
          reagents.map(name => {
            const id = name.replace(/\s+/g, '_');
            const lot = document.getElementById(`lot-${id}`).value.trim().toUpperCase();
            const exp = document.getElementById(`exp-${id}`).value;
            return `${name} | Lot: ${lot} | Exp: ${exp}`;
          })
        );
        const text = lines.join('\n');
        qr.value = text;
        document.getElementById('qr-text').textContent = text;
        printBtn.disabled = false;
      });
      printBtn.addEventListener('click', () => {
        if (!qr.value) return;
        const popup = window.open('', '_blank');
        if (!popup) {
          alert('Please allow popups to print the QR code.');
          return;
        }
        const imgData = qrCanvas.toDataURL();
        const safeText = escapeHtml(qr.value).replace(/\n/g, '<br>');
        const html =
          `<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Print QR</title></head>` +
          `<body onload=\"window.focus();window.print();window.close();\" style=\"text-align:center;font-family:sans-serif;\">` +
          `<img src=\"${imgData}\" alt=\"Reagent QR Code\"><p>${safeText}</p>` +
          `</body></html>`;
        popup.document.open();
        popup.document.write(html);
        popup.document.close();
      });
    });
  </script>
</body>
</html>
